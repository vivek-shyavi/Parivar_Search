name: Flask CI/CD Pipeline - Localhost

on:
  push:
    branches:
      - main  # Trigger on push to main

jobs:
  build:
    runs-on: windows-latest  # Running on Windows
    
    steps:
      - name: Checkout Repository (Pull latest code)
        uses: actions/checkout@v3

      - name: Print GitHub Workspace Path
        shell: pwsh
        run: |
          Write-Host "GitHub Workspace: ${{ github.workspace }}"

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        shell: pwsh
        run: |
          python -m venv venv
          venv\Scripts\activate
          python.exe -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir -r backend/requirements.txt

      - name: Create ZIP for Deployment
        shell: pwsh
        run: |
          $PROJECT_NAME = "ParivarSearch"
          $ZIP_NAME = "$PROJECT_NAME.zip"
          $DEPLOYMENT_PATH = "${{ github.workspace }}\Deployment"

          # Ensure the Deployment directory exists
          if (-Not (Test-Path $DEPLOYMENT_PATH)) { New-Item -ItemType Directory -Path $DEPLOYMENT_PATH -Force | Out-Null}

          # Create ZIP archive
          Compress-Archive -Path "${{ github.workspace }}\*" -DestinationPath "$DEPLOYMENT_PATH\$ZIP_NAME" -Force

          Write-Host "ZIP file created at: $DEPLOYMENT_PATH\$ZIP_NAME"

      - name: Upload ZIP as Artifact (Download from GitHub)
        uses: actions/upload-artifact@v3
        with:
          name: ParivarSearch-ZIP
          path: ${{ github.workspace }}\Deployment\ParivarSearch.zip

  deploy:
    needs: build
    runs-on: windows-latest

    steps:
      - name: Download ZIP from Artifacts
        uses: actions/download-artifact@v3
        with:
          name: ParivarSearch-ZIP
          path: C:\Users\vivek\source\repos\githubProjects

      - name: Deploy Locally from ZIP
        shell: pwsh
        run: |
          echo "Starting local deployment on Windows..."

          $LOCAL_PATH = "C:\Users\vivek\source\repos\githubProjects"
          $DEPLOY_PATH = "C:\Users\vivek\source\repos\githubDeployed"
          $ZIP_NAME = "ParivarSearch.zip"
          $ZIP_PATH = "$LOCAL_PATH\$ZIP_NAME"

          # Ensure the deployment directory exists
          if (-Not (Test-Path $DEPLOY_PATH)) { New-Item -ItemType Directory -Path $DEPLOY_PATH -Force | Out-Null}
          
          # Extract ZIP
          Expand-Archive -Path $ZIP_PATH -DestinationPath $DEPLOY_PATH -Force

          Write-Host "Deployment completed successfully."

      - name: Run Flask App
        shell: pwsh
        run: |
          cd C:\Users\vivek\source\repos\githubDeployed\ParivarSearch
          python -m venv venv
          venv\Scripts\activate
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir -r backend/requirements.txt
          python app.py
