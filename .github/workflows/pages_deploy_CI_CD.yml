name: Deploy Flask App to Windows PC

on:
  push:
    branches:
      - main  # Adjust branch if needed

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Zip the Project
        run: Compress-Archive -Path * -DestinationPath flask_app.zip -Force

      - name: Copy ZIP to Windows PC via PowerShell Remoting
        run: |
          $session = New-PSSession -ComputerName "${{ secrets.WINDOWS_IP }}" -Credential (New-Object PSCredential("${{ secrets.WINDOWS_USER }}", (ConvertTo-SecureString "${{ secrets.WINDOWS_PASSWORD }}" -AsPlainText -Force)))
          Copy-Item -Path flask_app.zip -Destination "C:\Users\${{ secrets.WINDOWS_USER }}\Downloads\flask_app.zip" -ToSession $session
        shell: pwsh

      - name: Extract and Run Flask App
        run: |
          $session = New-PSSession -ComputerName "${{ secrets.WINDOWS_IP }}" -Credential (New-Object PSCredential("${{ secrets.WINDOWS_USER }}", (ConvertTo-SecureString "${{ secrets.WINDOWS_PASSWORD }}" -AsPlainText -Force)))
          
          Invoke-Command -Session $session -ScriptBlock {
            Expand-Archive -Path "C:\Users\${{ secrets.WINDOWS_USER }}\Downloads\flask_app.zip" -DestinationPath "C:\Users\${{ secrets.WINDOWS_USER }}\flask_app" -Force
            cd "C:\Users\${{ secrets.WINDOWS_USER }}\flask_app"
            
            python -m venv venv
            .\venv\Scripts\Activate
            
            python.exe -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install -r backend/requirements.txt
            
            python app.py
          }
        shell: pwsh
